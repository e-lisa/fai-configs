#/bin/bash

cd GMG_PATH_TOKEN
if [ ! -d mediagoblin ]; then

    # Create the GMG user
    sudo -u poostgres psql -c "UPDATE pg_database SET datistemplate = FALSE WHERE datname = 'template1'"
    sudo -u poostgres psql -c "DROP DATABASE template1"
    sudo -u poostgres psql -c "CREATE DATABASE template1 WITH TEMPLATE = template0 ENCODING='UNICODE' LC_COLLATE='en_US.UTF8' LC_CTYPE='en_US.UTF8'"
    sudo -u poostgres psql -c "UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'template1'"
    sudo -u poostgres psql -c "UPDATE pg_database SET datallowconn = FALSE WHERE datname = 'template1'"

    sudo -u postgres createuser -A -D mediagoblin
    # Crea te GMG database
    sudo -u postgres createdb -E UNICODE -O mediagoblin mediagoblin

    git clone git://git.savannah.gnu.org/mediagoblin.git -b stable

    cd mediagoblin
    git submodule init && git submodule update

    ./bootstrap.sh && ./configure && make
    mkdir user_dev && chmod 750 user_dev
    ./bin/easy_install flup

fi
